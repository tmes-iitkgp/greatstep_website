{% extends "base.html" %}
{% block title %}Verify OTP - TMES{% endblock %}

{% block extra_css %}
<style>
    .auth-container {
        min-height: calc(100vh - 150px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        background-color: var(--color-bg, #0E2E50);
    }
    
    .auth-card {
        background-color: #1a3a5c !important;
        border-radius: 15px;
        overflow: hidden;
        width: 100%;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .auth-header {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
        padding: 30px;
        text-align: center;
    }
    
    .auth-header h2 {
        color: #ffffff !important;
        font-size: 1.8rem;
        margin: 0;
        font-weight: 600 !important;
    }
    
    .auth-header p {
        color: rgba(255, 255, 255, 0.8) !important;
        margin: 10px 0 0 0;
        font-size: 0.95rem;
    }
    
    .auth-body {
        padding: 40px 30px;
        background-color: #1a3a5c !important;
    }
    
    .email-display {
        background: rgba(255, 255, 255, 0.1) !important;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 25px;
    }
    
    .email-display p {
        color: #94c2f5 !important;
        margin: 0 0 5px 0;
        font-size: 0.9rem;
    }
    
    .email-display strong {
        color: #ffffff !important;
        font-size: 1.1rem;
    }
    
    .otp-input-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
    }
    
    .otp-input {
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 1.8rem;
        font-weight: 600 !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 10px;
        background-color: rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
        outline: none;
        transition: all 0.3s ease;
    }
    
    .otp-input:focus {
        border-color: #2563eb !important;
        background-color: rgba(37, 99, 235, 0.2) !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
    }
    
    .otp-input::-webkit-outer-spin-button,
    .otp-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    .otp-input[type=number] {
        -moz-appearance: textfield;
    }
    
    /* Hidden input for actual OTP value */
    #otp-hidden {
        display: none;
    }
    
    .submit-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
        color: #ffffff !important;
        border: none !important;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600 !important;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .submit-btn:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(37, 99, 235, 0.4);
    }
    
    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .resend-container {
        text-align: center;
        margin-top: 25px;
    }
    
    .resend-container p {
        color: rgba(255, 255, 255, 0.7) !important;
        font-size: 0.95rem;
        margin: 0;
    }
    
    .resend-link {
        color: #60a5fa !important;
        text-decoration: none;
        font-weight: 500 !important;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .resend-link:hover {
        color: #93c5fd !important;
        text-decoration: underline;
    }
    
    .resend-link.disabled {
        color: rgba(255, 255, 255, 0.4) !important;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .timer {
        color: #fbbf24 !important;
        font-weight: 600 !important;
    }
    
    .back-link {
        display: block;
        text-align: center;
        margin-top: 20px;
        color: rgba(255, 255, 255, 0.6) !important;
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.3s ease;
    }
    
    .back-link:hover {
        color: #ffffff !important;
    }
    
    .error-message {
        background-color: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #fca5a5;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 0.9rem;
    }
    
    .success-message {
        background-color: rgba(34, 197, 94, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.5);
        color: #86efac;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 0.9rem;
    }

    /* Responsive styles for mobile devices */
    @media (max-width: 600px) {
        .auth-container {
            padding: 20px 15px;
            min-height: calc(100vh - 100px);
        }
        
        .auth-card {
            max-width: 95%;
        }
        
        .auth-header {
            padding: 20px 15px;
        }
        
        .auth-header h2 {
            font-size: 1.5rem;
        }
        
        .auth-header p {
            font-size: 0.9rem;
        }
        
        .auth-body {
            padding: 25px 20px;
        }
        
        .otp-input-container {
            gap: 8px;
            margin-bottom: 25px;
        }
        
        .otp-input {
            width: 45px;
            height: 50px;
            font-size: 1.5rem;
        }
        
        .submit-btn {
            padding: 12px;
            font-size: 1rem;
        }
        
        .resend-container p {
            font-size: 0.9rem;
        }
        
        .back-link {
            font-size: 0.85rem;
        }
        
        .error-message, .success-message {
            padding: 10px;
            font-size: 0.85rem;
        }
    }

    @media (max-width: 480px) {
        .auth-container {
            padding: 15px 10px;
        }
        
        .auth-card {
            max-width: 98%;
        }
        
        .auth-header {
            padding: 18px 12px;
        }
        
        .auth-header h2 {
            font-size: 1.4rem;
        }
        
        .auth-body {
            padding: 20px 15px;
        }
        
        .otp-input-container {
            gap: 6px;
        }
        
        .otp-input {
            width: 40px;
            height: 45px;
            font-size: 1.3rem;
        }
        
        .submit-btn {
            padding: 10px;
            font-size: 0.95rem;
        }
        
        .email-display {
            padding: 12px;
        }
        
        .email-display strong {
            font-size: 1rem;
        }
    }

    @media (max-width: 360px) {
        .auth-header h2 {
            font-size: 1.3rem;
        }
        
        .otp-input {
            width: 35px;
            height: 40px;
            font-size: 1.2rem;
        }
        
        .submit-btn {
            padding: 8px;
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container" style="background-color: #0E2E50 !important;">
    <div class="auth-card" style="background-color: #1a3a5c !important;">
        <div class="auth-header">
            <h2>Verify OTP</h2>
            <p>Enter the 6-digit code sent to your email</p>
        </div>
        <div class="auth-body" style="background-color: #1a3a5c !important; padding: 40px 30px;">
            {% if error %}
            <div class="error-message">{{ error }}</div>
            {% endif %}
            
            {% if success %}
            <div class="success-message">{{ success }}</div>
            {% endif %}
            
            <div class="email-display" style="background: rgba(255, 255, 255, 0.1) !important;">
                <p style="color: #94c2f5 !important;">We sent a code to</p>
                <strong style="color: #ffffff !important;">{{ email }}</strong>
            </div>
            
            {% if dev_otp %}
            <div style="background: linear-gradient(135deg, #059669 0%, #047857 100%); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                <p style="color: #a7f3d0; margin: 0 0 5px 0; font-size: 0.85rem;">üîß DEV MODE - Your OTP Code:</p>
                <strong style="color: #ffffff; font-size: 2rem; letter-spacing: 8px;">{{ dev_otp }}</strong>
            </div>
            {% endif %}
            
            <form method="POST" action="{{ action_url }}" id="otp-form">
                <div class="otp-input-container" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 30px;">
                    <input type="number" class="otp-input" maxlength="1" data-index="0" autofocus style="width: 50px; height: 60px; text-align: center; font-size: 1.8rem; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background-color: rgba(37, 99, 235, 0.3) !important; color: #ffffff !important;">
                    <input type="number" class="otp-input" maxlength="1" data-index="1" style="width: 50px; height: 60px; text-align: center; font-size: 1.8rem; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background-color: rgba(37, 99, 235, 0.3) !important; color: #ffffff !important;">
                    <input type="number" class="otp-input" maxlength="1" data-index="2" style="width: 50px; height: 60px; text-align: center; font-size: 1.8rem; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background-color: rgba(37, 99, 235, 0.3) !important; color: #ffffff !important;">
                    <input type="number" class="otp-input" maxlength="1" data-index="3" style="width: 50px; height: 60px; text-align: center; font-size: 1.8rem; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background-color: rgba(37, 99, 235, 0.3) !important; color: #ffffff !important;">
                    <input type="number" class="otp-input" maxlength="1" data-index="4" style="width: 50px; height: 60px; text-align: center; font-size: 1.8rem; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background-color: rgba(37, 99, 235, 0.3) !important; color: #ffffff !important;">
                    <input type="number" class="otp-input" maxlength="1" data-index="5" style="width: 50px; height: 60px; text-align: center; font-size: 1.8rem; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background-color: rgba(37, 99, 235, 0.3) !important; color: #ffffff !important;">
                </div>
                
                <input type="hidden" name="otp" id="otp-hidden">
                <input type="hidden" name="email" value="{{ email }}">
                <input type="hidden" name="purpose" value="{{ purpose }}">
                
                <button type="submit" class="submit-btn" id="verify-btn" disabled style="width: 100%; padding: 15px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important; color: #ffffff !important; border: none !important; border-radius: 8px; font-size: 1.1rem; font-weight: 600 !important; cursor: pointer;">Verify</button>
            </form>
            
            <div class="resend-container" style="text-align: center; margin-top: 25px;">
                <p style="color: rgba(255, 255, 255, 0.7) !important;">Didn't receive the code? 
                    <span class="resend-link disabled" id="resend-link" style="color: #60a5fa !important;">
                        Resend <span class="timer" id="timer" style="color: #fbbf24 !important;">(60s)</span>
                    </span>
                </p>
            </div>
            
            <a href="{{ back_url }}" class="back-link" style="display: block; text-align: center; margin-top: 20px; color: rgba(255, 255, 255, 0.6) !important; text-decoration: none;">‚Üê Go back</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const otpInputs = document.querySelectorAll('.otp-input');
    const hiddenInput = document.getElementById('otp-hidden');
    const verifyBtn = document.getElementById('verify-btn');
    const resendLink = document.getElementById('resend-link');
    const timerSpan = document.getElementById('timer');
    
    let countdown = 60;
    
    // Handle OTP input
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            // Only allow single digit
            this.value = this.value.slice(-1);
            
            // Move to next input
            if (this.value && index < 5) {
                otpInputs[index + 1].focus();
            }
            
            updateHiddenInput();
        });
        
        input.addEventListener('keydown', function(e) {
            // Handle backspace
            if (e.key === 'Backspace' && !this.value && index > 0) {
                otpInputs[index - 1].focus();
            }
            
            // Handle arrow keys
            if (e.key === 'ArrowLeft' && index > 0) {
                otpInputs[index - 1].focus();
            }
            if (e.key === 'ArrowRight' && index < 5) {
                otpInputs[index + 1].focus();
            }
        });
        
        // Handle paste
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
            
            pasteData.split('').forEach((char, i) => {
                if (otpInputs[i]) {
                    otpInputs[i].value = char;
                }
            });
            
            updateHiddenInput();
            
            // Focus last filled input or the one after pasted content
            const focusIndex = Math.min(pasteData.length, 5);
            otpInputs[focusIndex].focus();
        });
    });
    
    function updateHiddenInput() {
        let otp = '';
        otpInputs.forEach(input => {
            otp += input.value;
        });
        hiddenInput.value = otp;
        
        // Enable/disable verify button
        verifyBtn.disabled = otp.length !== 6;
    }
    
    // Countdown timer for resend
    const timerInterval = setInterval(() => {
        countdown--;
        timerSpan.textContent = `(${countdown}s)`;
        
        if (countdown <= 0) {
            clearInterval(timerInterval);
            resendLink.classList.remove('disabled');
            timerSpan.style.display = 'none';
        }
    }, 1000);
    
    // Handle resend
    resendLink.addEventListener('click', function() {
        if (this.classList.contains('disabled')) return;
        
        // Make AJAX request to resend OTP
        const email = document.querySelector('input[name="email"]').value;
        const purpose = document.querySelector('input[name="purpose"]').value;
        
        fetch('/resend-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, purpose })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('OTP resent successfully!', 'success');
                // Reset timer
                countdown = 60;
                timerSpan.style.display = 'inline';
                this.classList.add('disabled');
            } else {
                showToast(data.message || 'Failed to resend OTP', 'error');
            }
        })
        .catch(error => {
            showToast('Failed to resend OTP', 'error');
        });
    });
});
</script>
{% endblock %}
